FROM arch:latest

USER arch
WORKDIR /home/arch

# Base installed, lets get specific
RUN yay -S --noconfirm \
  vulkan-headers \
  vulkan-icd-loader \
  vulkan-radeon \
  shaderc \
  rocwmma \
  rocm-hip-sdk \
  hip-runtime-amd \
  && sudo pacman -Scc --noconfirm

ENV PATH="/opt/rocm/bin:${PATH}" \
    HIP_PATH=/opt/rocm \
    ROCM_PATH=/opt/rocm

#STABLE-DIFFUSION.CPP
#https://github.com/leejet/stable-diffusion.cpp
    
RUN git clone --recursive https://github.com/leejet/stable-diffusion.cpp && \
    mv stable-diffusion.cpp stable-diffusion.cpp.rocm && \
    cp -r stable-diffusion.cpp.rocm stable-diffusion.cpp.vulkan

WORKDIR /home/arch/stable-diffusion.cpp.rocm
RUN cmake -B build -G "Ninja" \
    -DCMAKE_C_COMPILER=/opt/rocm/lib/llvm/bin/clang \
    -DCMAKE_CXX_COMPILER=/opt/rocm/lib/llvm/bin/clang++ \
    -DSD_HIPBLAS=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DAMDGPU_TARGETS=gfx1100
RUN cmake --build build --config Release --parallel

WORKDIR /home/arch/stable-diffusion.cpp.vulkan
RUN cmake -B build -G "Ninja" \
    -DSD_VULKAN=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DAMDGPU_TARGETS=gfx1100
RUN cmake --build build --config Release --parallel

#https://github.com/daniandtheweb/sd.cpp-webui
WORKDIR /home/arch/
RUN git clone https://github.com/daniandtheweb/sd.cpp-webui.git && \
    mv sd.cpp-webui sd.cpp-webui.rocm && \
    cp -r sd.cpp-webui.rocm sd.cpp-webui.vulkan
    
RUN cp stable-diffusion.cpp.rocm/build/bin/sd sd.cpp-webui.rocm && \
    cp stable-diffusion.cpp.vulkan/build/bin/sd sd.cpp-webui.vulkan

WORKDIR /home/arch/sd.cpp-webui.rocm
RUN chmod a+x sdcpp_webui.sh && \
    python3 -m venv venv && \
    source venv/bin/activate && \
    pip install -r requirements.txt --upgrade pip
    
WORKDIR /home/arch/sd.cpp-webui.vulkan
RUN chmod a+x sdcpp_webui.sh && \
    python3 -m venv venv && \
    source venv/bin/activate && \
    pip install -r requirements.txt --upgrade pip
